################################################################################
#  Licensed to the Apache Software Foundation (ASF) under one
#  or more contributor license agreements.  See the NOTICE file
#  distributed with this work for additional information
#  regarding copyright ownership.  The ASF licenses this file
#  to you under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance
#  with the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
# limitations under the License.
################################################################################

# shell configurations which must be set at top level.

common:

  ## Fault Tolerance
  ### Restart-strategy
  #### Default restart-strategy
  restart-strategy: aggregated-failure-rate
  restart-strategy.aggregated-failure-rate.max-failures-per-interval: 100
  restart-strategy.aggregated-failure-rate.failure-rate-interval: 40 min
  restart-strategy.aggregated-failure-rate.delay: 20 s
  #### Default restart-strategy configure for Batch
  restart-strategy.aggregated-fixed-delay.max-failures: 8
  restart-strategy.aggregated-fixed-delay.delay: 10 s
  #### Config for previous default restart-strategy
  restart-strategy.failure-rate.max-failures-per-interval: 100
  restart-strategy.failure-rate.failure-rate-interval: 40 min
  restart-strategy.failure-rate.delay: 20 s
  #### Config for Recoverable failover
  restart-strategy.recoverable-failure-rate.fallback-global-restart: true
  restart-strategy.recoverable-failure-rate.enable: true
  ### Default failover strategy
  # TODO(zoudan):add region restart monitor
  jobmanager.execution.failover-strategy: region
  jobmanager.execution.status-dutation-ms: 30000

  ## Checkpoints and State Backends
  #  io.tmp.dirs: /opt/tmp/flink
  #  taskmanager.tmp.dirs: /opt/tmp/flink
  state.backend: rocksdb
  state.checkpoints.dir: file:///tmp
  state.backend.incremental: true
  state.checkpoints.num-retained: 3
  state.backend.rocksdb.checkpoint.transfer.thread.num: 4
  state.backend.rocksdb.use-fsync: true
  state.backend.rocksdb.log.level: info_level
  state.backend.rocksdb.stats.dump.period.seconds: 600
  state.backend.rocksdb.monit.running.status: true
  state.backend.rocksdb.force-ssd: false
  state.backend.rocksdb.compaction.level.use-dynamic-size: true
  state.backend.state-file-batch.enable: true
  execution.checkpointing.mode: EXACTLY_ONCE
  execution.checkpointing.timeout: 10 min
  execution.checkpointing.ignore-checkpoints-on-checkpoint-disabled: true
  checkpoint.discard.historical.num: 3
  checkpoint.discard.delay.time: 1800000
  state.backend.rocksdb.restore-with-sstWriter: true
  state.backend.rocksdb.max-disk-size-in-progress: 30gb
  state.backend.rocksdb.max-sst-size-for-sstWriter: 64mb
  state.backend.rocksdb.memory.managed: false

  ## Heartbeat Services
  heartbeat.interval: 40000 # default 10000 ms
  heartbeat.timeout: 180000 # default 50000 ms

  ## Memory Configuration
  taskmanager.memory.managed.fraction: 0.25
  taskmanager.memory.network.fraction: 0.3
  taskmanager.memory.network.max: 2147483648

  ## StreamPipelineOptions
  pipeline.time-characteristic: EventTime

  # configuration
  configuration.flink-conf.dump-configuration-by-yaml: true

  # kubernetes configuration
  kubernetes.flink.log.dir: /opt/tiger/flink_deploy/log
  kubernetes.flink.conf.dir: /opt/tiger/flink_deploy/conf
  kubernetes.entry.path: /opt/tiger/flink_deploy/bin/kubernetes-entry.sh
  kubernetes.namespace: gts
  kubernetes.container.work.dir: /opt/tiger/workdir
  pipeline.file-mounted-path: /opt/tiger/workdir
  kubernetes.taskmanager.cpu: 2.0
  kubernetes.jobmanager.cpu: 1.0
  kubernetes.service-account: gts
  kubernetes.rest-service.exposed.type: ClusterIP

  # Arcee configuration
  kubernetes.arcee.scheduling-config.schedule-timeout-seconds: 120
  kubernetes.arcee.restart-policy.max-retries: 5
  kubernetes.arcee.restart-policy.interval-second: 5
  kubernetes.arcee.restart-policy.type: Never

  # REST endpoint and Client
  rest.await-leader-timeout: 300000
  rest.retry.max-attempts: 30
  rest.retry.delay: 10000

  # Web UI
  web.submit.enable: false

  # Full JobManager Options
  resourcemanager.taskmanager-timeout: 600000
  slot.request.timeout: 300000
  execution.cancellation.timeout.ms: 300000
  execution.cancellation.timeout.enable: true

  # Full TaskManagerOptions
  # The Netty send and receive buffer size.
  taskmanager.network.netty.sendReceiveBufferSize: 4194304
  taskmanager.serializer.prune.buffer.threshold: 262144
  taskmanager.network.netty.connection.tcp-user-timeout-seconds: 600

  # RPC / Akka
  akka.ask.timeout: 180 s # default 10 s
  akka.lookup.timeout: 60 s
  akka.tcp.timeout: 80 s

  # JVM and Logging Options
  env.gc.log.opts: -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=100M
  env.jvm.error.file: true
  flink.gc.g1: false
  flink.parallel.gc.thread.use.cores: true
  flink.enable-async-logger: true

  # am failover recovery
  yarn.previous-container.as-pending-container: true
  resourcemanager.previous-container.as-pending-container: true
  taskmanager.release-slot-when-job-master-disconnected.enabled: true

  # Table & SQL configurations.
  # validate before execute, e.g. hive permission check.
  table.exec.validate-before-execute: true

  # enable dynamic table options by default.
  table.dynamic-table-options.enabled: true

  # Load-balance scheduler
  nmclientasync.enabled: true
  taskmanager.initial-on-start: false
  jobmanager.upload-user-jar: false
  taskmanager.number-extra-initial: 0
  taskmanager.extra-initial-fraction: 0

  # Miscellaneous Options
  stream-partitioner.default: rescale
  ####job.work.dir: ${hdfs.prefix}/${clusterName}/1.11/
  flink.partition-discovery.interval-millis: 600000 # default 10min for kafka partition auto discovery interval.

  taskmanager.network.memory.lazy-allocate: true

  # bytedance streaming default config
  bytedance.streaming.taskmanager.initial-on-start: true
  bytedance.streaming.taskmanager.number-initial-percentage: 1.0
  bytedance.streaming.flink.job_api: DataStream
  bytedance.streaming.jobmanager.partition.release-during-job-execution: false
  bytedance.streaming.execution.wait-running-on-detached: true
  bytedance.streaming.cluster.evenly-spread-out-slots: false
  bytedance.streaming.jobmanager.slot-sharing-execution-slot-allocator.enabled: true
  bytedance.streaming.slot-pool.round-robin: true
  bytedance.streaming.slot-pool.min-resource.simplify-enabled: true
  bytedance.streaming.register-dashboard.enabled: true
  bytedance.streaming.restart-strategy: aggregated-failure-rate
  bytedance.streaming.kubernetes.arcee.restart-policy.type: OnFailure

  # hdfs conf for slow node
  flink.hdfs.dfs.datanode.socket.write.timeout: 30000
  flink.hdfs.dfs.client.socket-timeout: 30000
  flink.hdfs.ipc.client.ping: false
  flink.hdfs.ipc.ping.interval: 10000
  flink.hdfs.ipc.client.connect.max.retries.on.timeouts: 5
  flink.hdfs.ipc.client.connect.timeout: 2000
  flink.hdfs.ipc.client.connect.retry.interval: 500

  # cloud shuffle service
  flink.cloud-shuffle-service.support: false
  flink.cloud-shuffle-service.get-css-jar-from-coordinator: false
  flink.cloud-shuffle-service.report-job-status-to-coordinator: false
  flink.cloud-shuffle-service.css.compression.codec: lz4

  # stateBackend cache layer
  state.backend.cache.enable: true
  state.backend.cache.maxHeapSize: 1g
  state.backend.cache.blockSize: 4m
  state.backend.cache.initial.size: 4m
  state.backend.cache.maxSize: 64m
  state.backend.cache.scale.enable: true
  state.backend.cache.gcCountThreshold: 40
  state.backend.cache.avgGcTimeThreshold: 3000
  state.backend.cache.maxGcTimeThreshold: 10000
  state.backend.cache.lowHeapThreshold: 0.4

  # UI
  web.log-url-enable: false
  web.shell-enable: false
  web.metrics-url-enable: false
  web.dtop-url-enable: false
  web.display-container-real-resource-enable: true

  pipeline.register-dashboard-enable: false

  #==============================================================================
  #
  # Other Configuration
  #
  #==============================================================================
  parallelism.default: 1
  prune.buffer.threshold: 262144
  historyserver.web.tmpdir: /opt/tmp/flink/historyserver/tmpdir
  flink.lib.path: lib_new_conf
  resourcemanager.shuffle-pending-slots: false
  jobmanager.execution.schedule-task-fairly: false

  #Metrics
  metrics.reporters: promgateway
  metrics.reporter.promgateway.class: org.apache.flink.metrics.prometheus.PrometheusPushGatewayReporter
  metrics.reporter.promgateway.host: prometheus-pushgateway.monitor.svc
  metrics.reporter.promgateway.port: 9091
  metrics.reporter.promgateway.jobName: serverlessFlinkPromgatewayJobs
  metrics.reporter.promgateway.randomJobNameSuffix: true
  metrics.reporter.promgateway.deleteOnShutdown: false
  metrics.reporter.promgateway.groupingKey: k1=v1;k2=v2
  metrics.reporter.promgateway.interval: 30 SECONDS
